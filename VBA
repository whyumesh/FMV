Sub ExportDoctorDataToExcel()
    Dim olApp As Outlook.Application
    Dim olNamespace As Outlook.NameSpace
    Dim olFolder As Outlook.MAPIFolder
    Dim olMail As Object
    Dim xlApp As Object, xlWB As Object, xlSheet As Object
    Dim i As Long
    Dim RegExp As Object, Matches As Object
    Dim bodyText As String, subjectText As String
    Dim lines() As String, Line As Variant
    Dim ticketNo As String
    Dim currentName As String, currentCode As String, currentEmail As String
    
    ' Outlook objects
    Set olApp = Outlook.Application
    Set olNamespace = olApp.GetNamespace("MAPI")
    ' ⚠️ Change folder path as needed
    Set olFolder = olNamespace.Folders("umesh.pawar@abbott.com").Folders("Archive").Folders("Complete")
    
    ' Excel objects
    Set xlApp = CreateObject("Excel.Application")
    xlApp.Visible = True
    Set xlWB = xlApp.Workbooks.Add
    Set xlSheet = xlWB.Sheets(1)
    
    ' Headers
    xlSheet.Cells(1, 1).Value = "Ticket No"
    xlSheet.Cells(1, 2).Value = "Doctor Name"
    xlSheet.Cells(1, 3).Value = "DVL Code"
    xlSheet.Cells(1, 4).Value = "Doctor Email"
    
    i = 2
    
    ' RegExp
    Set RegExp = CreateObject("VBScript.RegExp")
    RegExp.IgnoreCase = True
    
    ' Loop mails
    For Each olMail In olFolder.Items
        If TypeOf olMail Is Outlook.MailItem Then
            bodyText = olMail.Body
            subjectText = olMail.Subject
            
            ' Extract Ticket No (pattern "CHMP" + digits)
            ticketNo = ""
            RegExp.Pattern = "(CHMP\d+)"
            If RegExp.Test(subjectText) Then
                Set Matches = RegExp.Execute(subjectText)
                ticketNo = Matches(0)
            End If
            
            ' Split body lines
            lines = Split(bodyText, vbCrLf)
            
            currentName = ""
            currentCode = ""
            currentEmail = ""
            
            For Each Line In lines
                Line = Trim(Line)
                If Line = "" Then GoTo SkipLine
                
                ' Find doctor email (ignore abbott emails)
                If currentEmail = "" Then
                    RegExp.Pattern = "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}"
                    If RegExp.Test(Line) Then
                        Set Matches = RegExp.Execute(Line)
                        If InStr(Matches(0), "@abbott.com") = 0 Then
                            currentEmail = Matches(0)
                        End If
                    End If
                End If
                
                ' Find DVL code
                If currentCode = "" Then
                    RegExp.Pattern = "\b(DS|DVL|ORC|GJ)[-\w]+\b"
                    If RegExp.Test(Line) Then
                        Set Matches = RegExp.Execute(Line)
                        currentCode = Matches(0)
                    End If
                End If
                
                ' Find doctor name
                If currentName = "" And (InStr(1, Line, "Dr", vbTextCompare) > 0) Then
                    ' Capture line as doctor name
                    currentName = Line
                End If
                
                ' If all 3 found, write row
                If currentName <> "" And currentCode <> "" And currentEmail <> "" Then
                    xlSheet.Cells(i, 1).Value = ticketNo
                    xlSheet.Cells(i, 2).Value = currentName
                    xlSheet.Cells(i, 3).Value = currentCode
                    xlSheet.Cells(i, 4).Value = currentEmail
                    i = i + 1
                    
                    ' Reset for next doctor
                    currentName = ""
                    currentCode = ""
                    currentEmail = ""
                End If
                
SkipLine:
            Next Line
        End If
    Next olMail
    
    MsgBox "Doctor data export complete!", vbInformation
End Sub
